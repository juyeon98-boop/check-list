<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œí•˜ì¤‘í•™êµ 2í•™ë…„ ë°œí‘œ ì²´í¬ë¦¬ìŠ¤íŠ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Brush+Script&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #f0f4f8; --primary-color: #2c3e50; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ğŸ“° ì‹ ë¬¸ í—¤ë“œë¼ì¸ ìŠ¤íƒ€ì¼ ì œëª© ë°” */
        #headline-bar {
            display: flex; align-items: center; justify-content: center;
            background-color: white; padding: 15px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 10px;
            border-bottom: 5px solid var(--primary-color);
        }
        .school-logo { height: 50px; margin-right: 15px; } /* êµí‘œ í¬ê¸° */
        .headline-title {
            font-family: 'Nanum Brush Script', cursive; /* ê·€ì—¬ìš´ ê¸€ì”¨ì²´ */
            font-size: 3.5rem; color: var(--primary-color); margin: 0;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        /* ì»¨íŠ¸ë¡¤ ë°” (íŒŒì¼ ì—…ë¡œë“œ/ì €ì¥) */
        #control-bar {
            height: 50px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.8); padding: 0 20px; border-radius: 10px;
            margin-bottom: 10px; backdrop-filter: blur(5px);
        }
        .btn-save { background-color: #27ae60; color: white; border: none; padding: 8px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-save:hover { background-color: #219150; transform: scale(1.05); }

        /* ê·¸ë¦¬ë“œ ì˜ì—­ */
        .grid-container { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(4, 1fr); gap: 10px; flex-grow: 1; }

        /* í•™ìƒ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .student-card { background: white; border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: all 0.3s ease; border: 4px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .student-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* íšŸìˆ˜ë³„ íš¨ê³¼ */
        .card-orange { border-color: #e67e22 !important; background-color: #fffaf5; }
        .card-red { border-color: #e74c3c !important; background-color: #fff5f5; animation: pulse-red 1.5s infinite alternate; }

        @keyframes pulse-red { from { box-shadow: 0 0 10px rgba(231, 76, 60, 0.4); } to { box-shadow: 0 0 20px rgba(231, 76, 60, 0.7); } }

        /* ì•„ë°”íƒ€ ë° í…ìŠ¤íŠ¸ */
        .animal-img { width: 50%; aspect-ratio: 1/1; border-radius: 50%; margin-bottom: 5px; }
        .name { font-size: 1.2vw; font-weight: bold; color: #333; }
        .class-no { font-size: 0.8vw; color: #888; }
        
        /* ë°°ì§€ */
        .count-badge { position: absolute; top: 8px; right: 8px; background: #34495e; color: white; padding: 2px 10px; border-radius: 12px; font-weight: bold; font-size: 1.1vw; }
        .card-red .count-badge { background: #e74c3c; }
    </style>
</head>
<body>

<div id="headline-bar">
    <img src="https://search.pstatic.net/common/?src=http%3A%2F%2Fblogfiles.naver.net%2MjAxOTAzMjFfMjgx%2FMDAxNTUzMTU4MTkyNDYw.8_JvD3H2H1N_b4r-C-7G2S2M_4W1_S5U7_H_E9F_gIg.PNG.sohamiddle%2Flogo.png&type=sc960_832" alt="ì†Œí•˜ì¤‘ êµí‘œ" class="school-logo" onerror="this.style.display='none'">
    <h1 class="headline-title">ì†Œí•˜ì¤‘í•™êµ 2í•™ë…„ ë°œí‘œ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>
</div>

<div id="control-bar">
    <div>
        <strong>CSV ë¶ˆëŸ¬ì˜¤ê¸°: </strong>
        <input type="file" id="csvFile" accept=".csv">
    </div>
    <div id="file-info" style="font-size: 0.9rem; color: #666;"></div>
    <button class="btn-save" onclick="downloadCSV()">ìƒˆ íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°</button>
</div>

<div class="grid-container" id="grid">
    <div style="grid-column: span 8; text-align: center; padding-top: 50px; color: #bbb; font-size: 1.3rem;">
        CSV íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë©´ ëª…ë ¬í‘œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
    </div>
</div>

<script>
    let studentData = [];
    let originalPrefix = ""; 
    const grid = document.getElementById('grid');

    window.onbeforeunload = function() { return "ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."; };

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const fileName = file.name;
        const match = fileName.match(/^(\d+)/);
        originalPrefix = match ? match[1] : "ì†Œí•˜ì¤‘_ë°œí‘œ";

        document.getElementById('file-info').innerText = `í˜„ì¬ íŒŒì¼: ${fileName}`;

        const reader = new FileReader();
        reader.readAsText(file, 'CP949'); 

        reader.onload = function(event) {
            const text = event.target.result;
            const rows = text.trim().split(/\r?\n/);
            grid.innerHTML = '';
            studentData = [];

            rows.forEach((row, index) => {
                const cols = row.split(',');
                if (cols.length >= 3 && index < 32) {
                    const student = {
                        class: cols[0].trim(),
                        no: cols[1].trim(),
                        name: cols[2].trim(),
                        count: parseInt(cols[3]) || 0
                    };
                    studentData.push(student);
                    createCard(student, index);
                }
            });
        };
    });

    function createCard(data, index) {
        const card = document.createElement('div');
        card.id = `card-${index}`;
        updateCardStyle(card, data.count);
        
        // ê·€ì—¬ìš´ ì•„ë°”íƒ€ ìŠ¤íƒ€ì¼ ë³€ê²½ (adventurer)
        const imgUrl = `https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(data.name)}`;
        
        card.innerHTML = `
            <div class="count-badge" id="count-${index}">${data.count}</div>
            <img class="animal-img" src="${imgUrl}">
            <div class="info">
                <div class="class-no">${data.class}ë°˜ ${data.no}ë²ˆ</div>
                <div class="name">${data.name}</div>
            </div>
        `;

        card.onclick = () => {
            studentData[index].count++;
            const newCount = studentData[index].count;
            document.getElementById(`count-${index}`).innerText = newCount;
            updateCardStyle(card, newCount);
        };

        grid.appendChild(card);
    }

    function updateCardStyle(card, count) {
        card.className = 'student-card'; 
        if (count > 30) {
            card.classList.add('card-red');
        } else if (count > 10) {
            card.classList.add('card-orange');
        }
    }

    function downloadCSV() {
        if (studentData.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        let csvContent = "";
        studentData.forEach(s => {
            csvContent += `${s.class},${s.no},${s.name},${s.count}\n`;
        });

        const today = new Date();
        const dateStr = today.getFullYear() + 
                        String(today.getMonth() + 1).padStart(2, '0') + 
                        String(today.getDate()).padStart(2, '0');

        const newFileName = `${originalPrefix}_${dateStr}.csv`;

        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = newFileName;
        link.click();
    }
</script>
</body>
</html>
