<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>귀여운 동물 발표 체크판 (저장기능 포함)</title>
    <style>
        :root { --bg-color: #fdf6e3; --card-bg: #ffffff; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #header { height: 60px; display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 0 20px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .btn-save { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-save:hover { background-color: #45a049; }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 12px;
            flex-grow: 1;
            width: 100%;
        }

        .student-card {
            background: var(--card-bg);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            border: 3px solid transparent;
        }

        .student-card:hover { border-color: #ffcc00; transform: translateY(-3px); }
        .student-card:active { transform: scale(0.95); background-color: #fff9db; }

        .animal-img { width: 50%; aspect-ratio: 1/1; border-radius: 50%; margin-bottom: 5px; background: #eee; }
        .name { font-size: 1.2vw; font-weight: bold; color: #444; }
        .class-no { font-size: 0.9vw; color: #999; }
        
        .count-badge {
            position: absolute; top: 10px; right: 10px;
            background: #ffa502; color: white;
            padding: 4px 12px; border-radius: 15px;
            font-weight: bold; font-size: 1.2vw;
        }
    </style>
</head>
<body>

<div id="header">
    <div>
        <strong>CSV 불러오기: </strong>
        <input type="file" id="csvFile" accept=".csv">
    </div>
    <button class="btn-save" onclick="downloadCSV()">현재 상태 CSV로 저장하기</button>
</div>

<div class="grid-container" id="grid">
    <div style="grid-column: span 8; text-align: center; padding-top: 100px; color: #999; font-size: 1.5rem;">
        먼저 CSV 파일을 선택해주세요 (형식: 반, 번호, 이름, 횟수)
    </div>
</div>

<script>
    let studentData = [];
    const grid = document.getElementById('grid');

    // 페이지를 닫으려 할 때 경고창 띄우기
    window.onbeforeunload = function() {
        return "데이터를 저장하지 않았을 수 있습니다. 정말 나가시겠습니까?";
    };

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.readAsText(file, 'CP949'); 

        reader.onload = function(event) {
            const text = event.target.result;
            const rows = text.trim().split(/\r?\n/);
            grid.innerHTML = '';
            studentData = [];

            rows.forEach((row, index) => {
                const cols = row.split(',');
                if (cols.length >= 3 && index < 32) {
                    const student = {
                        class: cols[0].trim(),
                        no: cols[1].trim(),
                        name: cols[2].trim(),
                        count: parseInt(cols[3]) || 0 // 4번째 열이 없으면 0으로 시작
                    };
                    studentData.push(student);
                    createCard(student, index);
                }
            });
        };
    });

    function createCard(data, index) {
        const card = document.createElement('div');
        card.className = 'student-card';
        
        // 귀여운 동물 아바타 (Big Ears 스타일 사용)
        const imgUrl = `https://api.dicebear.com/7.x/big-ears-neutral/svg?seed=${encodeURIComponent(data.name)}`;
        
        card.innerHTML = `
            <div class="count-badge" id="count-${index}">${data.count}</div>
            <img class="animal-img" src="${imgUrl}">
            <div class="info">
                <div class="class-no">${data.class}반 ${data.no}번</div>
                <div class="name">${data.name}</div>
            </div>
        `;

        card.onclick = () => {
            studentData[index].count++;
            document.getElementById(`count-${index}`).innerText = studentData[index].count;
        };

        grid.appendChild(card);
    }

    // 수정된 데이터를 다시 CSV 파일로 다운로드하는 함수
    function downloadCSV() {
        let csvContent = ""; // BOM 제거 (엑셀 인코딩 호환용)
        studentData.forEach(s => {
            csvContent += `${s.class},${s.no},${s.name},${s.count}\n`;
        });

        // 한글 깨짐 방지를 위한 팁: Blob 생성 시 MS 엑셀이 인식하는 EUC-KR 대신 UTF-8 사용 시 한글 깨짐 우려가 있으나, 
        // 최신 방식인 데이터 URI 대신 Blob 방식을 사용합니다.
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        
        link.setAttribute("href", url);
        link.setAttribute("download", "발표횟수_업데이트.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>